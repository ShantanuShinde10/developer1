name: SonarQube Analysis (Windows Self-Hosted)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar_analysis:
    runs-on: self-hosted  # Uses your Windows machine

    steps:
    - name: Disable SSL Verification (Temporary Fix)
      run: |
        git config --global http.sslVerify false
      shell: bash

    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Ensure SonarQube is Running
      run: |
        echo "Waiting for SonarQube to be ready..."
        $maxAttempts = 10
        $attempt = 0
        while ($attempt -lt $maxAttempts) {
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:9000/api/system/status" -UseBasicParsing
            if ($response.Content -match '"status":"UP"') {
              echo "SonarQube is UP!"
              exit 0
            }
          } catch {
            echo "SonarQube is not ready yet..."
          }
          Start-Sleep -Seconds 5
          $attempt++
        }
        echo "SonarQube did not start in time. Exiting."
        exit 1
      shell: pwsh

    - name: Run SonarScanner
      run: |
        sonar-scanner.bat ^
          -Dsonar.projectKey=shantanushinde10 ^
          -Dsonar.sources=. ^
          -Dsonar.host.url=http://localhost:9000 ^
          -Dsonar.login=${{ secrets.SONARQUBE_TOKEN }}
      shell: cmd
