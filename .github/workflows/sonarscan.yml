name: SonarQube Analysis (Windows Self-Hosted)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar_analysis:
    runs-on: self-hosted  # Runs on your Windows machine

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Disable SSL Verification (Temporary Fix)
      run: |
        git config --global http.sslVerify false
      shell: pwsh

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Ensure SonarQube is Running
      run: |
        echo "Waiting for SonarQube to be ready..."
        while (-not (Invoke-WebRequest -Uri "http://localhost:9000/api/system/status" -UseBasicParsing | Select-String '"status":"UP"')) {
          Start-Sleep -Seconds 5
        }
        echo "SonarQube is UP!"
      shell: pwsh

    - name: Run SonarScanner
      run: |
        sonar-scanner.bat ^
          -Dsonar.projectKey=shantanushinde10 ^
          -Dsonar.sources=. ^
          -Dsonar.host.url=http://localhost:9000 ^
          -Dsonar.login=your_sonarqube_token_here
      shell: cmd
